<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1150" style="background: white;">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#374151"/>
    </marker>
    <marker id="arrow-left" markerWidth="10" markerHeight="7" refX="1" refY="3.5" orient="auto">
      <polygon points="10 0, 0 3.5, 10 7" fill="#374151"/>
    </marker>
  </defs>

  <!-- Title -->
  <text x="450" y="40" text-anchor="middle" font-family="system-ui, sans-serif" font-size="26" font-weight="bold" fill="#111827">GPT-2 Architecture</text>
  <text x="450" y="65" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" fill="#6b7280">B=32 (batch) | T=256 (seq len) | C=384 (embed) | V=65 (vocab) | H=6 (heads)</text>

  <!-- Dimension Legend Box -->
  <rect x="760" y="90" width="220" height="160" rx="8" fill="#f0f9ff" stroke="#0ea5e9" stroke-width="2"/>
  <text x="870" y="115" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#0369a1">Config Values</text>
  <text x="780" y="140" font-family="monospace" font-size="12" fill="#374151">B = 32  (batch_size)</text>
  <text x="780" y="160" font-family="monospace" font-size="12" fill="#374151">T = 256 (block_size)</text>
  <text x="780" y="180" font-family="monospace" font-size="12" fill="#374151">C = 384 (n_embd)</text>
  <text x="780" y="200" font-family="monospace" font-size="12" fill="#374151">V = 65  (vocab_size)</text>
  <text x="780" y="220" font-family="monospace" font-size="12" fill="#374151">H = 6   (n_head)</text>
  <text x="780" y="240" font-family="monospace" font-size="12" fill="#374151">C/H = 64 (head_dim)</text>

  <!-- ==================== INPUT ==================== -->
  <rect x="350" y="100" width="200" height="50" rx="8" fill="#f3f4f6" stroke="#6b7280" stroke-width="2"/>
  <text x="450" y="125" text-anchor="middle" font-family="system-ui, sans-serif" font-size="15" font-weight="600" fill="#374151">Input Token IDs</text>
  <text x="450" y="143" text-anchor="middle" font-family="monospace" font-size="12" fill="#6b7280">(32, 256)</text>

  <!-- Arrow down to embeddings -->
  <line x1="450" y1="150" x2="450" y2="185" stroke="#374151" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ==================== EMBEDDINGS ==================== -->
  <rect x="200" y="190" width="500" height="100" rx="10" fill="#eff6ff" stroke="#3b82f6" stroke-width="2"/>
  <text x="450" y="215" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#1e40af">Embeddings (transformer.wte + transformer.wpe)</text>

  <!-- wte -->
  <rect x="220" y="230" width="200" height="50" rx="6" fill="#dbeafe" stroke="#60a5fa" stroke-width="1.5"/>
  <text x="320" y="253" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="600" fill="#1e40af">wte: Token Embedding</text>
  <text x="320" y="271" text-anchor="middle" font-family="monospace" font-size="11" fill="#3b82f6">(65, 384) → (32, 256, 384)</text>

  <!-- Plus -->
  <text x="450" y="263" text-anchor="middle" font-family="system-ui, sans-serif" font-size="24" font-weight="bold" fill="#1e40af">+</text>

  <!-- wpe -->
  <rect x="480" y="230" width="200" height="50" rx="6" fill="#dbeafe" stroke="#60a5fa" stroke-width="1.5"/>
  <text x="580" y="253" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="600" fill="#1e40af">wpe: Position Embedding</text>
  <text x="580" y="271" text-anchor="middle" font-family="monospace" font-size="11" fill="#3b82f6">(256, 384) → (32, 256, 384)</text>

  <!-- Arrow down from embeddings with shape label -->
  <line x1="450" y1="290" x2="450" y2="330" stroke="#374151" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="480" y="300" width="100" height="20" rx="4" fill="#e0f2fe" stroke="#38bdf8" stroke-width="1"/>
  <text x="530" y="314" text-anchor="middle" font-family="monospace" font-size="11" font-weight="600" fill="#0284c7">(32, 256, 384)</text>

  <!-- ==================== TRANSFORMER BLOCKS ==================== -->
  <rect x="120" y="335" width="660" height="600" rx="12" fill="#fefce8" stroke="#eab308" stroke-width="2" stroke-dasharray="8,4"/>
  <text x="140" y="360" font-family="system-ui, sans-serif" font-size="15" font-weight="bold" fill="#a16207">transformer.h — ModuleList of 6 Blocks</text>

  <!-- ==================== SINGLE BLOCK ==================== -->
  <rect x="150" y="375" width="600" height="530" rx="10" fill="#fff7ed" stroke="#f97316" stroke-width="2"/>
  <text x="450" y="402" text-anchor="middle" font-family="system-ui, sans-serif" font-size="16" font-weight="bold" fill="#c2410c">Block[i] (repeated 6 times)</text>

  <!-- ========== ATTENTION PATH ========== -->

  <!-- Input x -->
  <text x="175" y="450" font-family="monospace" font-size="12" font-weight="600" fill="#374151">x</text>
  <rect x="190" y="436" width="100" height="24" rx="4" fill="#e0f2fe" stroke="#38bdf8" stroke-width="1"/>
  <text x="240" y="453" text-anchor="middle" font-family="monospace" font-size="11" fill="#0284c7">(32,256,384)</text>

  <!-- Arrow to ln_1 -->
  <line x1="290" y1="448" x2="320" y2="448" stroke="#374151" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ln_1 -->
  <rect x="325" y="428" width="100" height="45" rx="6" fill="#f0fdf4" stroke="#22c55e" stroke-width="2"/>
  <text x="375" y="450" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="600" fill="#166534">ln_1</text>
  <text x="375" y="466" text-anchor="middle" font-family="monospace" font-size="10" fill="#22c55e">(32,256,384)</text>

  <!-- Arrow to attention -->
  <line x1="425" y1="450" x2="455" y2="450" stroke="#374151" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Attention -->
  <rect x="460" y="420" width="160" height="62" rx="6" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
  <text x="540" y="442" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="600" fill="#92400e">CausalSelfAttention</text>
  <text x="540" y="458" text-anchor="middle" font-family="monospace" font-size="9" fill="#b45309">Q,K,V: (32, 6, 256, 64)</text>
  <text x="540" y="474" text-anchor="middle" font-family="monospace" font-size="9" fill="#b45309">out: (32, 256, 384)</text>

  <!-- Arrow to add circle -->
  <line x1="620" y1="450" x2="660" y2="450" stroke="#374151" stroke-width="2"/>

  <!-- Add circle 1 -->
  <circle cx="680" cy="450" r="18" fill="white" stroke="#374151" stroke-width="2"/>
  <text x="680" y="456" text-anchor="middle" font-family="system-ui, sans-serif" font-size="18" font-weight="bold" fill="#374151">+</text>

  <!-- Residual connection 1 (bypass attention) -->
  <path d="M 240 460 L 240 495 L 680 495 L 680 468" fill="none" stroke="#9ca3af" stroke-width="2" stroke-dasharray="6,3"/>
  <text x="460" y="512" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="#9ca3af" font-style="italic">residual: x + attn(ln_1(x))</text>

  <!-- Output shape after attention -->
  <rect x="705" y="438" width="100" height="24" rx="4" fill="#e0f2fe" stroke="#38bdf8" stroke-width="1"/>
  <text x="755" y="455" text-anchor="middle" font-family="monospace" font-size="11" fill="#0284c7">(32,256,384)</text>

  <!-- ========== MLP PATH ========== -->

  <!-- Vertical line down from attention add -->
  <line x1="680" y1="468" x2="680" y2="555" stroke="#374151" stroke-width="2"/>

  <!-- x label -->
  <text x="695" y="570" font-family="monospace" font-size="12" font-weight="600" fill="#374151">x</text>

  <!-- Arrow left to ln_2 -->
  <line x1="680" y1="575" x2="610" y2="575" stroke="#374151" stroke-width="2" marker-end="url(#arrow-left)"/>

  <!-- ln_2 -->
  <rect x="505" y="553" width="100" height="45" rx="6" fill="#f0fdf4" stroke="#22c55e" stroke-width="2"/>
  <text x="555" y="575" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="600" fill="#166534">ln_2</text>
  <text x="555" y="591" text-anchor="middle" font-family="monospace" font-size="10" fill="#22c55e">(32,256,384)</text>

  <!-- Arrow to MLP -->
  <line x1="505" y1="575" x2="475" y2="575" stroke="#374151" stroke-width="2" marker-end="url(#arrow-left)"/>

  <!-- ==================== MLP BLOCK ==================== -->
  <rect x="180" y="535" width="290" height="220" rx="8" fill="#fce7f3" stroke="#ec4899" stroke-width="2"/>
  <text x="325" y="560" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#9d174d">MLP (Feed-Forward Network)</text>

  <!-- c_fc (receives from ln_2) -->
  <rect x="355" y="575" width="115" height="55" rx="6" fill="#fbcfe8" stroke="#f472b6" stroke-width="1.5"/>
  <text x="412" y="595" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="600" fill="#be185d">c_fc</text>
  <text x="412" y="612" text-anchor="middle" font-family="monospace" font-size="10" fill="#db2777">384 → 1536</text>
  <text x="412" y="626" text-anchor="middle" font-family="monospace" font-size="9" fill="#ec4899">(32,256,1536)</text>

  <!-- Arrow down from c_fc to GELU -->
  <line x1="412" y1="630" x2="412" y2="655" stroke="#374151" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- GELU -->
  <rect x="365" y="660" width="95" height="35" rx="6" fill="#d1fae5" stroke="#10b981" stroke-width="1.5"/>
  <text x="412" y="683" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="600" fill="#065f46">GELU(tanh)</text>

  <!-- Arrow down from GELU to c_proj -->
  <line x1="412" y1="695" x2="412" y2="720" stroke="#374151" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- c_proj -->
  <rect x="195" y="660" width="115" height="55" rx="6" fill="#fbcfe8" stroke="#f472b6" stroke-width="1.5"/>
  <text x="252" y="680" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="600" fill="#be185d">c_proj</text>
  <text x="252" y="697" text-anchor="middle" font-family="monospace" font-size="10" fill="#db2777">1536 → 384</text>
  <text x="252" y="711" text-anchor="middle" font-family="monospace" font-size="9" fill="#ec4899">(32,256,384)</text>

  <!-- Connect GELU output to c_proj input -->
  <path d="M 412 720 L 412 735 L 310 735 L 310 690" fill="none" stroke="#374151" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- MLP output line going left and down to add circle -->
  <line x1="195" y1="690" x2="170" y2="690" stroke="#374151" stroke-width="2"/>
  <line x1="170" y1="690" x2="170" y2="810" stroke="#374151" stroke-width="2"/>
  <line x1="170" y1="810" x2="210" y2="810" stroke="#374151" stroke-width="2"/>

  <!-- Add circle 2 -->
  <circle cx="230" cy="810" r="18" fill="white" stroke="#374151" stroke-width="2"/>
  <text x="230" y="816" text-anchor="middle" font-family="system-ui, sans-serif" font-size="18" font-weight="bold" fill="#374151">+</text>

  <!-- Residual connection 2 (bypass MLP) -->
  <path d="M 680 575 L 720 575 L 720 810 L 248 810" fill="none" stroke="#9ca3af" stroke-width="2" stroke-dasharray="6,3"/>
  <text x="500" y="830" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="#9ca3af" font-style="italic">residual: x + mlp(ln_2(x))</text>

  <!-- Output shape from block -->
  <rect x="255" y="798" width="100" height="24" rx="4" fill="#e0f2fe" stroke="#38bdf8" stroke-width="1"/>
  <text x="305" y="815" text-anchor="middle" font-family="monospace" font-size="11" fill="#0284c7">(32,256,384)</text>

  <!-- Arrow down from block output -->
  <line x1="230" y1="828" x2="230" y2="870" stroke="#374151" stroke-width="2"/>
  <line x1="230" y1="870" x2="450" y2="870" stroke="#374151" stroke-width="2"/>

  <!-- Repeat indicator -->
  <text x="450" y="905" text-anchor="middle" font-family="system-ui, sans-serif" font-size="20" fill="#a16207">⋮ ⋮ ⋮</text>
  <text x="560" y="905" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" fill="#a16207">(repeat for all 6 blocks)</text>

  <!-- Arrow out of blocks container -->
  <line x1="450" y1="935" x2="450" y2="975" stroke="#374151" stroke-width="2" marker-end="url(#arrow)"/>
  <rect x="480" y="945" width="100" height="20" rx="4" fill="#e0f2fe" stroke="#38bdf8" stroke-width="1"/>
  <text x="530" y="959" text-anchor="middle" font-family="monospace" font-size="11" font-weight="600" fill="#0284c7">(32, 256, 384)</text>

  <!-- ==================== FINAL LAYER NORM ==================== -->
  <rect x="325" y="980" width="250" height="50" rx="8" fill="#f0fdf4" stroke="#22c55e" stroke-width="2"/>
  <text x="450" y="1003" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="600" fill="#166534">ln_f (Final LayerNorm)</text>
  <text x="450" y="1023" text-anchor="middle" font-family="monospace" font-size="11" fill="#22c55e">(32, 256, 384) → (32, 256, 384)</text>

  <!-- Arrow to lm_head -->
  <line x1="450" y1="1030" x2="450" y2="1060" stroke="#374151" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ==================== LM HEAD ==================== -->
  <rect x="310" y="1065" width="280" height="50" rx="8" fill="#ede9fe" stroke="#8b5cf6" stroke-width="2"/>
  <text x="450" y="1088" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="600" fill="#5b21b6">lm_head (Linear, no bias)</text>
  <text x="450" y="1108" text-anchor="middle" font-family="monospace" font-size="11" fill="#7c3aed">(32, 256, 384) → (32, 256, 65)</text>

  <!-- Arrow to output -->
  <line x1="450" y1="1115" x2="450" y2="1140" stroke="#374151" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ==================== OUTPUT ==================== -->
  <rect x="350" y="1145" width="200" height="40" rx="8" fill="#f3f4f6" stroke="#6b7280" stroke-width="2"/>
  <text x="450" y="1165" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="600" fill="#374151">Output Logits</text>
  <text x="450" y="1182" text-anchor="middle" font-family="monospace" font-size="12" font-weight="bold" fill="#374151">(32, 256, 65)</text>

</svg>